{% extends "base.html" %} {% block title %}Settings{% endblock %} {% block
content %}
<div x-data="settingsPage()" x-init="loadSettings()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold">Settings</h1>
        <p class="text-base-content/60">
            Configure proxy settings and defaults
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Default Model -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Default Model</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Fallback model used when an unknown model is requested
                </p>

                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Provider</span>
                        </label>
                        <select
                            x-model="settings.default_provider"
                            @change="loadProviderModels()"
                            class="select select-bordered"
                        >
                            <option value="">Select provider</option>
                            <template x-for="p in providers" :key="p.id">
                                <option :value="p.id" x-text="p.id"></option>
                            </template>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Model</span>
                        </label>
                        <select
                            x-model="settings.default_model"
                            class="select select-bordered"
                        >
                            <option value="">Select model</option>
                            <template x-for="m in providerModels" :key="m.id">
                                <option :value="m.id" x-text="m.id"></option>
                            </template>
                        </select>
                    </div>

                    <button
                        @click="saveSettings()"
                        class="btn btn-primary"
                        :class="{ 'loading': saving }"
                    >
                        Save Default
                    </button>
                </div>
            </div>
        </div>

        <!-- Change Password -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Admin Password</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Change the admin dashboard password
                </p>

                <form @submit.prevent="changePassword()" class="space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">New Password</span>
                        </label>
                        <input
                            type="password"
                            x-model="newPassword"
                            class="input input-bordered"
                            placeholder="Enter new password"
                            minlength="8"
                            required
                        />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Confirm Password</span>
                        </label>
                        <input
                            type="password"
                            x-model="confirmPassword"
                            class="input input-bordered"
                            placeholder="Confirm new password"
                            required
                        />
                    </div>

                    <button
                        type="submit"
                        class="btn btn-primary"
                        :class="{ 'loading': changingPassword }"
                    >
                        Change Password
                    </button>
                </form>
            </div>
        </div>

        <!-- Import/Export -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">Configuration</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Import from YAML files or reload configuration
                </p>

                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input
                                type="checkbox"
                                x-model="importOverwrite"
                                class="checkbox"
                            />
                            <span class="label-text"
                                >Overwrite existing entries</span
                            >
                        </label>
                    </div>

                    <div class="flex gap-2">
                        <button
                            @click="importConfig()"
                            class="btn btn-outline"
                            :class="{ 'loading': importing }"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4 mr-1"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                                />
                            </svg>
                            Import from YAML
                        </button>

                        <button
                            @click="reloadConfig()"
                            class="btn btn-outline"
                            :class="{ 'loading': reloading }"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4 mr-1"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                />
                            </svg>
                            Reload Config
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Info -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">System Information</h2>
                <p class="text-sm text-base-content/60 mb-4">
                    Current proxy status
                </p>

                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Version:</span>
                        <span class="font-mono">2.1.0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Providers:</span>
                        <span x-text="stats.providers?.total || '-'"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Models:</span>
                        <span x-text="stats.models?.total || '-'"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-base-content/60">Aliases:</span>
                        <span x-text="stats.aliases?.total || '-'"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-base-content/60"
                            >Configured Providers:</span
                        >
                        <span
                            x-text="stats.providers?.configured || '-'"
                        ></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div class="toast toast-end">
        <template x-for="toast in toasts" :key="toast.id">
            <div
                class="alert"
                :class="toast.type === 'error' ? 'alert-error' : 'alert-success'"
            >
                <span x-text="toast.message"></span>
            </div>
        </template>
    </div>
</div>

<script>
    function settingsPage() {
        return {
            settings: {
                default_provider: "",
                default_model: "",
            },
            providers: [],
            providerModels: [],
            stats: {},
            saving: false,
            newPassword: "",
            confirmPassword: "",
            changingPassword: false,
            importOverwrite: false,
            importing: false,
            reloading: false,
            toasts: [],

            async loadSettings() {
                try {
                    const [settingsRes, providersRes, statsRes] =
                        await Promise.all([
                            fetch("/api/settings"),
                            fetch("/api/providers"),
                            fetch("/api/stats"),
                        ]);

                    if (settingsRes.ok) {
                        this.settings = await settingsRes.json();
                    }
                    if (providersRes.ok) {
                        this.providers = await providersRes.json();
                    }
                    if (statsRes.ok) {
                        this.stats = await statsRes.json();
                    }

                    // Load models for default provider
                    if (this.settings.default_provider) {
                        await this.loadProviderModels();
                    }
                } catch (err) {
                    this.showToast("Failed to load settings", "error");
                }
            },

            async loadProviderModels() {
                if (!this.settings.default_provider) {
                    this.providerModels = [];
                    return;
                }

                try {
                    const res = await fetch(
                        `/api/models?provider=${this.settings.default_provider}`,
                    );
                    if (res.ok) {
                        this.providerModels = await res.json();
                    }
                } catch (err) {
                    console.error("Failed to load models", err);
                }
            },

            async saveSettings() {
                this.saving = true;
                try {
                    const res = await fetch("/api/settings", {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(this.settings),
                    });

                    if (res.ok) {
                        this.showToast("Settings saved");
                    } else {
                        this.showToast("Failed to save settings", "error");
                    }
                } catch (err) {
                    this.showToast("Failed to save settings", "error");
                } finally {
                    this.saving = false;
                }
            },

            async changePassword() {
                if (this.newPassword !== this.confirmPassword) {
                    this.showToast("Passwords do not match", "error");
                    return;
                }

                if (this.newPassword.length < 8) {
                    this.showToast(
                        "Password must be at least 8 characters",
                        "error",
                    );
                    return;
                }

                this.changingPassword = true;
                try {
                    const res = await fetch("/api/settings/password", {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            new_password: this.newPassword,
                        }),
                    });

                    if (res.ok) {
                        this.showToast("Password changed successfully");
                        this.newPassword = "";
                        this.confirmPassword = "";
                    } else {
                        const data = await res.json();
                        this.showToast(
                            data.error || "Failed to change password",
                            "error",
                        );
                    }
                } catch (err) {
                    this.showToast("Failed to change password", "error");
                } finally {
                    this.changingPassword = false;
                }
            },

            async importConfig() {
                this.importing = true;
                try {
                    const res = await fetch("/api/config/import", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            overwrite: this.importOverwrite,
                        }),
                    });

                    if (res.ok) {
                        const data = await res.json();
                        this.showToast("Configuration imported successfully");
                        await this.loadSettings();
                    } else {
                        this.showToast(
                            "Failed to import configuration",
                            "error",
                        );
                    }
                } catch (err) {
                    this.showToast("Failed to import configuration", "error");
                } finally {
                    this.importing = false;
                }
            },

            async reloadConfig() {
                this.reloading = true;
                try {
                    const res = await fetch("/api/config/reload", {
                        method: "POST",
                    });

                    if (res.ok) {
                        this.showToast("Configuration reloaded");
                    } else {
                        this.showToast(
                            "Failed to reload configuration",
                            "error",
                        );
                    }
                } catch (err) {
                    this.showToast("Failed to reload configuration", "error");
                } finally {
                    this.reloading = false;
                }
            },

            showToast(message, type = "success") {
                const id = Date.now();
                this.toasts.push({ id, message, type });
                setTimeout(() => {
                    this.toasts = this.toasts.filter((t) => t.id !== id);
                }, 3000);
            },
        };
    }
</script>
{% endblock %}
